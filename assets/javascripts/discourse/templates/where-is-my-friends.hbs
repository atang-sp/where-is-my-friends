<div class="where-is-my-friends-container">
  <div class="where-is-my-friends-header">
    <h1>{{i18n "where_is_my_friends.title"}}</h1>
    <p>{{i18n "where_is_my_friends.description"}}</p>
  </div>

  {{#if this.error}}
    <div class="alert alert-error">
      <i class="fa fa-exclamation-triangle"></i>
      {{{this.error}}}
    </div>
  {{/if}}

  {{#if this.debugInfo}}
    <div class="alert alert-info">
      <details>
        <summary><i class="fa fa-bug"></i> 调试信息（点击展开）</summary>
        <pre>{{this.debugInfo}}</pre>
      </details>
    </div>
  {{/if}}

  {{#if this.loading}}
    <div class="alert alert-info">
      <i class="fa fa-spinner fa-spin"></i>
      {{i18n "where_is_my_friends.getting_location"}}
    </div>
  {{/if}}

  <!-- 位置模式选择对话框 -->
  {{#if this.showLocationModeDialog}}
    <div class="modal-backdrop">
      <div class="location-mode-dialog">
        <div class="dialog-header">
          <h3><i class="fa fa-map-marker-alt"></i> {{i18n "where_is_my_friends.choose_location_mode"}}</h3>
          <p>{{i18n "where_is_my_friends.privacy_intro"}}</p>
        </div>
        
        <div class="location-options">
          <div class="location-option real-location" {{action "selectRealLocation"}}>
            <div class="option-icon">
              <i class="fa fa-location-arrow"></i>
            </div>
            <div class="option-content">
              <h4>{{i18n "where_is_my_friends.real_location"}}</h4>
              <p>{{i18n "where_is_my_friends.real_location_desc"}}</p>
              <div class="option-pros">
                <span class="pro"><i class="fa fa-check"></i> {{i18n "where_is_my_friends.location_accurate"}}</span>
                <span class="pro"><i class="fa fa-check"></i> {{i18n "where_is_my_friends.auto_obtain"}}</span>
              </div>
            </div>
          </div>
          
          <div class="location-option virtual-location" {{action "selectVirtualLocation"}}>
            <div class="option-icon">
              <i class="fa fa-map"></i>
            </div>
            <div class="option-content">
              <h4>{{i18n "where_is_my_friends.virtual_location"}}</h4>
              <p>{{i18n "where_is_my_friends.virtual_location_desc"}}</p>
              <div class="option-pros">
                <span class="pro"><i class="fa fa-check"></i> {{i18n "where_is_my_friends.privacy_protection"}}</span>
                <span class="pro"><i class="fa fa-check"></i> {{i18n "where_is_my_friends.free_choice"}}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="dialog-footer">
          <button class="btn btn-default" {{action (mut this.showLocationModeDialog) false}}>
            <i class="fa fa-times"></i>
            {{i18n "where_is_my_friends.cancel"}}
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  <!-- 虚拟位置选择器 -->
  {{#if this.showVirtualLocationPicker}}
    <div class="modal-backdrop">
      <div class="virtual-location-modal">
        {{virtual-location-picker
          settings=this.model.settings
          onConfirm=(action "onVirtualLocationConfirm")
          onCancel=(action "onVirtualLocationCancel")
        }}
      </div>
    </div>
  {{/if}}

  <div class="where-is-my-friends-content">
    {{#if this.currentUser.location}}
      <div class="location-status">
        <div class="alert alert-success">
          <i class="fa fa-map-marker-alt"></i>
          {{#if this.currentUser.location.is_virtual}}
            {{i18n "where_is_my_friends.virtual_location_set"}}
            {{#if this.currentUser.location.virtual_address}}
              <div class="virtual-address">
                <small><i class="fa fa-map"></i> {{this.currentUser.location.virtual_address}}</small>
              </div>
            {{/if}}
          {{else}}
            {{i18n "where_is_my_friends.location_shared"}}
          {{/if}}
        </div>
        
        <div class="location-actions">
          <button class="btn btn-primary" {{action "findNearbyUsers"}} disabled={{this.loading}}>
            <i class="fa fa-search"></i>
            {{#if this.loading}}
              {{i18n "where_is_my_friends.searching_nearby"}}
            {{else}}
              {{i18n "where_is_my_friends.find_nearby"}}
            {{/if}}
          </button>
          
          <button class="btn btn-danger" {{action "removeLocation"}}>
            <i class="fa fa-trash"></i>
            {{i18n "where_is_my_friends.remove_location"}}
          </button>
        </div>
      </div>
    {{else}}
      <div class="location-setup">
        <div class="alert alert-info">
          <i class="fa fa-info-circle"></i>
          {{#if this.siteSettings.where_is_my_friends_enable_virtual_location}}
            {{i18n "where_is_my_friends.location_mode_prompt"}}
          {{else}}
            {{i18n "where_is_my_friends.share_location_prompt"}}
          {{/if}}
        </div>
        
        <button class="btn btn-primary btn-large" {{action "shareLocation"}} disabled={{this.loading}}>
          <i class="fa fa-map-marker-alt"></i>
          {{#if this.loading}}
            {{i18n "where_is_my_friends.getting_location"}}
          {{else}}
            {{#if this.siteSettings.where_is_my_friends_enable_virtual_location}}
              {{i18n "where_is_my_friends.choose_location_mode_button"}}
            {{else}}
              {{i18n "where_is_my_friends.share_location"}}
            {{/if}}
          {{/if}}
        </button>
        
        <button class="btn btn-secondary" {{action "checkPermissions"}}>
          <i class="fa fa-shield-alt"></i>
          {{i18n "where_is_my_friends.check_permissions"}}
        </button>
        
        {{#if this.permissionStatus}}
          <div class="permission-status">
            <p><strong>{{i18n "where_is_my_friends.permission_status"}}：</strong> {{this.permissionStatus}}</p>
          </div>
        {{/if}}
        
        <div class="location-tips">
          <h4><i class="fa fa-lightbulb"></i> {{i18n "where_is_my_friends.location_tips_title"}}</h4>
          <ul>
            {{#if this.siteSettings.where_is_my_friends_enable_virtual_location}}
              <li><strong>{{i18n "where_is_my_friends.real_location"}}：</strong>{{i18n "where_is_my_friends.real_location_tip"}}</li>
              <li><strong>{{i18n "where_is_my_friends.virtual_location"}}：</strong>{{i18n "where_is_my_friends.virtual_location_tip"}}</li>
              <li>{{i18n "where_is_my_friends.recommend_virtual"}}</li>
            {{else}}
              <li>{{i18n "where_is_my_friends.real_location_auto_tip"}}</li>
              <li>{{i18n "where_is_my_friends.indoor_tip"}}</li>
              <li>{{i18n "where_is_my_friends.location_service_tip"}}</li>
              <li>{{i18n "where_is_my_friends.chrome_tip"}}</li>
            {{/if}}
          </ul>
        </div>
      </div>
    {{/if}}

    {{#if this.nearbyUsers}}
      <div class="nearby-users">
        <div class="users-header">
          <div class="users-title">
            <h3>{{i18n "where_is_my_friends.nearby_users"}} ({{this.filteredUsers.length}})</h3>
          </div>
        </div>

        <div class="users-filters">
          <div class="filter-item">
            <label>{{i18n "where_is_my_friends.filter_by_gender"}}</label>
            <select onchange={{action (mut this.filterGender) value="target.value"}}>
              <option value="all">{{i18n "where_is_my_friends.all_genders"}}</option>
              <option value="male">{{i18n "where_is_my_friends.gender_male"}}</option>
              <option value="female">{{i18n "where_is_my_friends.gender_female"}}</option>
              <option value="other">{{i18n "where_is_my_friends.gender_other"}}</option>
              <option value="unknown">{{i18n "where_is_my_friends.gender_unknown"}}</option>
            </select>
          </div>

          <div class="filter-item filter-wide">
            <label>{{i18n "where_is_my_friends.filter_by_attributes"}}</label>
            <select onchange={{action (mut this.filterAttribute) value="target.value"}}>
              <option value="all">{{i18n "where_is_my_friends.attribute_all"}}</option>
              <option value="active">{{i18n "where_is_my_friends.attribute_active"}}</option>
              <option value="passive">{{i18n "where_is_my_friends.attribute_passive"}}</option>
              <option value="vers">{{i18n "where_is_my_friends.attribute_vers"}}</option>
            </select>
          </div>

          <div class="filter-item">
            <label>{{i18n "where_is_my_friends.sort_by"}}</label>
            <select onchange={{action (mut this.sortBy) value="target.value"}}>
              <option value="distance">{{i18n "where_is_my_friends.sort_distance"}}</option>
              <option value="recent">{{i18n "where_is_my_friends.sort_recent"}}</option>
            </select>
          </div>
        </div>
        
        <div class="users-list">
          {{#each this.filteredUsers as |userData|}}
            <div class="user-card {{if userData.isCurrentUser 'current-user'}} {{if userData.is_online 'online'}}">
              <div class="user-avatar">
                <a href="/u/{{userData.username}}">
                  {{avatar userData imageSize="large"}}
                </a>
                {{#if userData.isCurrentUser}}
                  <div class="current-user-badge">
                    <i class="fa fa-user"></i>
                  </div>
                {{/if}}
                {{#if userData.is_online}}
                  <div class="online-badge" title="{{i18n 'where_is_my_friends.user_online'}}">
                    <i class="fa fa-circle"></i>
                  </div>
                {{/if}}
              </div>
              
              <div class="user-info">
                <div class="user-header">
                  <div class="username">
                    <a href="/u/{{userData.username}}">{{userData.username}}</a>
                    {{#if userData.isCurrentUser}}
                      <span class="current-user-label">(您)</span>
                    {{/if}}
                  </div>
                  
                  <div class="distance">
                    <i class="fa fa-map-marker-alt"></i>
                    {{userData.location_display_name}}
                    {{#if userData.is_virtual}}
                      <span class="virtual-badge" title="{{i18n 'where_is_my_friends.using_virtual_location'}}">
                        <i class="fa fa-shield-alt"></i>
                      </span>
                    {{/if}}
                  </div>
                </div>
                
                {{#if userData.bio}}
                  <div class="user-bio">
                    <i class="fa fa-quote-left"></i>
                    <span class="bio-text">{{userData.bio}}</span>
                  </div>
                {{/if}}

                <div class="user-attributes">
                  {{#if userData.gender}}
                    <span class="attribute-tag gender-tag {{if (eq userData.gender "male") "gender-male" (if (eq userData.gender "female") "gender-female" "gender-other")}}">
                      <strong>{{i18n "where_is_my_friends.gender_label"}}:</strong>
                      {{#if (eq userData.gender "male")}}
                        {{i18n "where_is_my_friends.gender_male"}}
                      {{else if (eq userData.gender "female")}}
                        {{i18n "where_is_my_friends.gender_female"}}
                      {{else if (eq userData.gender "other")}}
                        {{i18n "where_is_my_friends.gender_other"}}
                      {{else}}
                        {{userData.gender}}
                      {{/if}}
                    </span>
                  {{/if}}

                  {{#if userData.user_fields}}
                    {{#each-in userData.user_fields as |key value|}}
                      <span class="attribute-tag">
                        <strong>{{key}}:</strong>
                        {{value}}
                      </span>
                    {{/each-in}}
                  {{/if}}
                </div>
                
                {{#if userData.last_seen_at}}
                  <div class="last-seen">
                    <i class="fa fa-clock-o"></i>
                    {{#if userData.is_online}}
                      <span class="online-text">在线</span>
                    {{else}}
                      最后在线: {{format-date userData.last_seen_at}}
                    {{/if}}
                  </div>
                {{/if}}
              </div>
            </div>
          {{/each}}
        </div>
        
        {{#unless this.filteredUsers.length}}
          <div class="no-users-found">
            {{#if this.filtersActive}}
              <p><i class="fa fa-info-circle"></i> {{i18n "where_is_my_friends.no_users_match_filters"}}</p>
              <button class="btn btn-default" {{action "clearFilters"}}>
                <i class="fa fa-eraser"></i>
                {{i18n "where_is_my_friends.clear_filters"}}
              </button>
            {{else}}
              <p><i class="fa fa-info-circle"></i> {{i18n "where_is_my_friends.no_users_found_range"}}</p>
            {{/if}}
          </div>
        {{/unless}}
      </div>
    {{/if}}
  </div>
</div> 
