<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†ä½ç½®è¯Šæ–­å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-width: 900px;
            line-height: 1.6;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb; 
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7; 
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border-color: #bee5eb; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        pre { 
            background-color: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto;
            font-size: 12px;
        }
        .loading { 
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .step { margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { margin: 5px 0; padding: 5px; }
        .checklist li:before { content: "â˜ "; }
        .checklist li.checked:before { content: "â˜‘ "; color: green; }
    </style>
</head>
<body>
    <h1>ğŸ” åœ°ç†ä½ç½®è¶…æ—¶é—®é¢˜è¯Šæ–­å·¥å…·</h1>
    
    <div class="section info">
        <h2>ğŸ“‹ è¯Šæ–­æ­¥éª¤</h2>
        <p>è¯·æŒ‰é¡ºåºå®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼Œæ‰¾å‡ºè¶…æ—¶é—®é¢˜çš„åŸå› ï¼š</p>
    </div>

    <!-- æ­¥éª¤1: åŸºç¡€æ£€æŸ¥ -->
    <div class="section" id="step1">
        <h3>æ­¥éª¤ 1: åŸºç¡€ç¯å¢ƒæ£€æŸ¥</h3>
        <button onclick="checkBasicEnvironment()">å¼€å§‹æ£€æŸ¥</button>
        <div id="basicResults"></div>
    </div>

    <!-- æ­¥éª¤2: ç½‘ç»œæ£€æŸ¥ -->
    <div class="section" id="step2">
        <h3>æ­¥éª¤ 2: ç½‘ç»œè¿æ¥æ£€æŸ¥</h3>
        <button onclick="checkNetwork()">æ£€æŸ¥ç½‘ç»œ</button>
        <div id="networkResults"></div>
    </div>

    <!-- æ­¥éª¤3: æƒé™æ£€æŸ¥ -->
    <div class="section" id="step3">
        <h3>æ­¥éª¤ 3: ä½ç½®æƒé™æ£€æŸ¥</h3>
        <button onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
        <div id="permissionResults"></div>
    </div>

    <!-- æ­¥éª¤4: è®¾å¤‡è®¾ç½®æ£€æŸ¥ -->
    <div class="section" id="step4">
        <h3>æ­¥éª¤ 4: è®¾å¤‡è®¾ç½®æ£€æŸ¥</h3>
        <div id="deviceChecklist">
            <h4>è¯·æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹è®¾ç½®ï¼š</h4>
            <ul class="checklist">
                <li>è®¾å¤‡ä½ç½®æœåŠ¡æ˜¯å¦å¼€å¯</li>
                <li>GPSæ˜¯å¦å¼€å¯</li>
                <li>æµè§ˆå™¨æ˜¯å¦æœ‰ä½ç½®æƒé™</li>
                <li>æ˜¯å¦åœ¨å®¤å†…ï¼ˆGPSä¿¡å·å¼±ï¼‰</li>
                <li>æ˜¯å¦æœ‰é˜²ç«å¢™é˜»æ­¢</li>
            </ul>
        </div>
    </div>

    <!-- æ­¥éª¤5: æµ‹è¯•ä¸åŒé€‰é¡¹ -->
    <div class="section" id="step5">
        <h3>æ­¥éª¤ 5: ä¸åŒé€‰é¡¹æµ‹è¯•</h3>
        <button onclick="testLowAccuracy()">æµ‹è¯•ä½ç²¾åº¦æ¨¡å¼</button>
        <button onclick="testHighAccuracy()">æµ‹è¯•é«˜ç²¾åº¦æ¨¡å¼</button>
        <button onclick="testWithCache()">æµ‹è¯•ç¼“å­˜æ¨¡å¼</button>
        <div id="testResults"></div>
    </div>

    <!-- æ­¥éª¤6: è§£å†³æ–¹æ¡ˆ -->
    <div class="section" id="step6">
        <h3>æ­¥éª¤ 6: è§£å†³æ–¹æ¡ˆ</h3>
        <button onclick="showSolutions()">æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ</button>
        <div id="solutions"></div>
    </div>

    <script>
        let diagnosticData = {
            basicCheck: false,
            networkCheck: false,
            permissionCheck: false,
            deviceCheck: false,
            testResults: []
        };

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function checkBasicEnvironment() {
            logResult('basicResults', '<span class="loading"></span> æ­£åœ¨æ£€æŸ¥åŸºç¡€ç¯å¢ƒ...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                // æ£€æŸ¥ Geolocation API æ”¯æŒ
                if (navigator.geolocation) {
                    results.push('âœ… æµè§ˆå™¨æ”¯æŒ Geolocation API');
                } else {
                    results.push('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Geolocation API');
                }
                
                // æ£€æŸ¥ HTTPS
                if (location.protocol === 'https:') {
                    results.push('âœ… ä½¿ç”¨ HTTPS åè®®');
                } else {
                    results.push('âš ï¸ ä½¿ç”¨ HTTP åè®®ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦ HTTPSï¼‰');
                }
                
                // æ£€æŸ¥ç”¨æˆ·ä»£ç†
                const userAgent = navigator.userAgent;
                results.push(`ğŸ“± æµè§ˆå™¨: ${userAgent}`);
                
                // æ£€æŸ¥å¹³å°
                results.push(`ğŸ’» å¹³å°: ${navigator.platform}`);
                
                // æ£€æŸ¥åœ¨çº¿çŠ¶æ€
                if (navigator.onLine) {
                    results.push('âœ… è®¾å¤‡åœ¨çº¿');
                } else {
                    results.push('âŒ è®¾å¤‡ç¦»çº¿');
                }
                
                diagnosticData.basicCheck = true;
                logResult('basicResults', results.join('<br>'), 'success');
            }, 1000);
        }

        function checkNetwork() {
            logResult('networkResults', '<span class="loading"></span> æ­£åœ¨æ£€æŸ¥ç½‘ç»œè¿æ¥...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                // æ£€æŸ¥åœ¨çº¿çŠ¶æ€
                if (navigator.onLine) {
                    results.push('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸');
                } else {
                    results.push('âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸');
                }
                
                // æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
                const startTime = performance.now();
                fetch('/favicon.ico', { method: 'HEAD' })
                    .then(() => {
                        const endTime = performance.now();
                        const latency = endTime - startTime;
                        results.push(`ğŸ“Š ç½‘ç»œå»¶è¿Ÿ: ${latency.toFixed(2)}ms`);
                        
                        if (latency < 100) {
                            results.push('âœ… ç½‘ç»œå»¶è¿Ÿæ­£å¸¸');
                        } else if (latency < 500) {
                            results.push('âš ï¸ ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜');
                        } else {
                            results.push('âŒ ç½‘ç»œå»¶è¿Ÿè¿‡é«˜');
                        }
                        
                        diagnosticData.networkCheck = true;
                        logResult('networkResults', results.join('<br>'), 'success');
                    })
                    .catch(() => {
                        results.push('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        diagnosticData.networkCheck = true;
                        logResult('networkResults', results.join('<br>'), 'error');
                    });
            }, 1000);
        }

        function checkPermissions() {
            logResult('permissionResults', '<span class="loading"></span> æ­£åœ¨æ£€æŸ¥ä½ç½®æƒé™...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                if (navigator.permissions && navigator.permissions.query) {
                    navigator.permissions.query({ name: 'geolocation' }).then(result => {
                        results.push(`ğŸ” æƒé™çŠ¶æ€: ${result.state}`);
                        
                        switch (result.state) {
                            case 'granted':
                                results.push('âœ… ä½ç½®æƒé™å·²æˆäºˆ');
                                break;
                            case 'denied':
                                results.push('âŒ ä½ç½®æƒé™è¢«æ‹’ç»');
                                break;
                            case 'prompt':
                                results.push('âš ï¸ éœ€è¦ç”¨æˆ·ç¡®è®¤ä½ç½®æƒé™');
                                break;
                        }
                        
                        diagnosticData.permissionCheck = true;
                        logResult('permissionResults', results.join('<br>'), 
                            result.state === 'granted' ? 'success' : 'warning');
                    });
                } else {
                    results.push('âš ï¸ æ— æ³•æŸ¥è¯¢æƒé™çŠ¶æ€ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰');
                    results.push('ğŸ’¡ è¯·æ‰‹åŠ¨æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                    diagnosticData.permissionCheck = true;
                    logResult('permissionResults', results.join('<br>'), 'warning');
                }
            }, 1000);
        }

        function testLowAccuracy() {
            testGeolocation('ä½ç²¾åº¦æ¨¡å¼', {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 0
            });
        }

        function testHighAccuracy() {
            testGeolocation('é«˜ç²¾åº¦æ¨¡å¼', {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }

        function testWithCache() {
            testGeolocation('ç¼“å­˜æ¨¡å¼', {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000
            });
        }

        function testGeolocation(mode, options) {
            const startTime = performance.now();
            logResult('testResults', `<span class="loading"></span> æ­£åœ¨æµ‹è¯•${mode}...`, 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    const result = {
                        mode: mode,
                        success: true,
                        duration: duration,
                        accuracy: position.coords.accuracy,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    diagnosticData.testResults.push(result);
                    
                    logResult('testResults', `
                        âœ… ${mode}æµ‹è¯•æˆåŠŸ<br>
                        â±ï¸ è€—æ—¶: ${duration.toFixed(2)}ms<br>
                        ğŸ“ ç²¾åº¦: ${position.coords.accuracy}ç±³<br>
                        ğŸŒ åæ ‡: ${position.coords.latitude}, ${position.coords.longitude}
                    `, 'success');
                },
                function(error) {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    const result = {
                        mode: mode,
                        success: false,
                        duration: duration,
                        error: error.code,
                        message: error.message
                    };
                    
                    diagnosticData.testResults.push(result);
                    
                    let errorMessage = '';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'æƒé™è¢«æ‹’ç»';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ä½ç½®ä¸å¯ç”¨';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'è¯·æ±‚è¶…æ—¶';
                            break;
                        default:
                            errorMessage = 'æœªçŸ¥é”™è¯¯';
                    }
                    
                    logResult('testResults', `
                        âŒ ${mode}æµ‹è¯•å¤±è´¥<br>
                        â±ï¸ è€—æ—¶: ${duration.toFixed(2)}ms<br>
                        ğŸš¨ é”™è¯¯: ${errorMessage}<br>
                        ğŸ“ è¯¦æƒ…: ${error.message}
                    `, 'error');
                },
                options
            );
        }

        function showSolutions() {
            let solutions = [];
            
            // åŸºäºè¯Šæ–­ç»“æœæä¾›è§£å†³æ–¹æ¡ˆ
            if (!diagnosticData.basicCheck) {
                solutions.push('ğŸ”§ è¯·å…ˆå®ŒæˆåŸºç¡€ç¯å¢ƒæ£€æŸ¥');
            }
            
            if (!diagnosticData.networkCheck) {
                solutions.push('ğŸ”§ è¯·å…ˆå®Œæˆç½‘ç»œæ£€æŸ¥');
            }
            
            if (!diagnosticData.permissionCheck) {
                solutions.push('ğŸ”§ è¯·å…ˆå®Œæˆæƒé™æ£€æŸ¥');
            }
            
            // é€šç”¨è§£å†³æ–¹æ¡ˆ
            solutions.push(`
                <h4>ğŸ› ï¸ å¸¸è§è§£å†³æ–¹æ¡ˆï¼š</h4>
                <ol>
                    <li><strong>æ£€æŸ¥ä½ç½®æƒé™</strong>ï¼šç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å®šå›¾æ ‡ï¼Œç¡®ä¿ä½ç½®æƒé™ä¸º"å…è®¸"</li>
                    <li><strong>å¼€å¯è®¾å¤‡ä½ç½®æœåŠ¡</strong>ï¼šåœ¨è®¾å¤‡è®¾ç½®ä¸­å¼€å¯ä½ç½®æœåŠ¡</li>
                    <li><strong>æ£€æŸ¥GPS</strong>ï¼šç¡®ä¿GPSå·²å¼€å¯ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰</li>
                    <li><strong>ç½‘ç»œè¿æ¥</strong>ï¼šç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸</li>
                    <li><strong>é˜²ç«å¢™è®¾ç½®</strong>ï¼šæ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†ä½ç½®æœåŠ¡</li>
                    <li><strong>æµè§ˆå™¨è®¾ç½®</strong>ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’ŒCookie</li>
                    <li><strong>å°è¯•ä¸åŒæ¨¡å¼</strong>ï¼šä½¿ç”¨ä½ç²¾åº¦æ¨¡å¼å¯èƒ½æ›´å¿«</li>
                    <li><strong>æ›´æ¢ä½ç½®</strong>ï¼šåœ¨å®¤å¤–æˆ–é è¿‘çª—æˆ·çš„åœ°æ–¹å°è¯•</li>
                </ol>
            `);
            
            // åŸºäºæµ‹è¯•ç»“æœçš„å»ºè®®
            if (diagnosticData.testResults.length > 0) {
                const successfulTests = diagnosticData.testResults.filter(r => r.success);
                const failedTests = diagnosticData.testResults.filter(r => !r.success);
                
                if (successfulTests.length > 0) {
                    solutions.push(`
                        <h4>âœ… æˆåŠŸçš„æµ‹è¯•ï¼š</h4>
                        <ul>
                            ${successfulTests.map(t => `<li>${t.mode}ï¼š${t.duration.toFixed(2)}msï¼Œç²¾åº¦${t.accuracy}ç±³</li>`).join('')}
                        </ul>
                    `);
                }
                
                if (failedTests.length > 0) {
                    solutions.push(`
                        <h4>âŒ å¤±è´¥çš„æµ‹è¯•ï¼š</h4>
                        <ul>
                            ${failedTests.map(t => `<li>${t.mode}ï¼š${t.message}</li>`).join('')}
                        </ul>
                    `);
                }
            }
            
            logResult('solutions', solutions.join('<br>'), 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹åŸºç¡€æ£€æŸ¥
        window.onload = function() {
            setTimeout(checkBasicEnvironment, 500);
        };
    </script>
</body>
</html> 