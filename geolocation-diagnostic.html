<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地理位置诊断工具</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-width: 900px;
            line-height: 1.6;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb; 
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7; 
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border-color: #bee5eb; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        pre { 
            background-color: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto;
            font-size: 12px;
        }
        .loading { 
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .step { margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { margin: 5px 0; padding: 5px; }
        .checklist li:before { content: "☐ "; }
        .checklist li.checked:before { content: "☑ "; color: green; }
    </style>
</head>
<body>
    <h1>🔍 地理位置超时问题诊断工具</h1>
    
    <div class="section info">
        <h2>📋 诊断步骤</h2>
        <p>请按顺序完成以下检查，找出超时问题的原因：</p>
    </div>

    <!-- 步骤1: 基础检查 -->
    <div class="section" id="step1">
        <h3>步骤 1: 基础环境检查</h3>
        <button onclick="checkBasicEnvironment()">开始检查</button>
        <div id="basicResults"></div>
    </div>

    <!-- 步骤2: 网络检查 -->
    <div class="section" id="step2">
        <h3>步骤 2: 网络连接检查</h3>
        <button onclick="checkNetwork()">检查网络</button>
        <div id="networkResults"></div>
    </div>

    <!-- 步骤3: 权限检查 -->
    <div class="section" id="step3">
        <h3>步骤 3: 位置权限检查</h3>
        <button onclick="checkPermissions()">检查权限</button>
        <div id="permissionResults"></div>
    </div>

    <!-- 步骤4: 设备设置检查 -->
    <div class="section" id="step4">
        <h3>步骤 4: 设备设置检查</h3>
        <div id="deviceChecklist">
            <h4>请手动检查以下设置：</h4>
            <ul class="checklist">
                <li>设备位置服务是否开启</li>
                <li>GPS是否开启</li>
                <li>浏览器是否有位置权限</li>
                <li>是否在室内（GPS信号弱）</li>
                <li>是否有防火墙阻止</li>
            </ul>
        </div>
    </div>

    <!-- 步骤5: 测试不同选项 -->
    <div class="section" id="step5">
        <h3>步骤 5: 不同选项测试</h3>
        <button onclick="testLowAccuracy()">测试低精度模式</button>
        <button onclick="testHighAccuracy()">测试高精度模式</button>
        <button onclick="testWithCache()">测试缓存模式</button>
        <div id="testResults"></div>
    </div>

    <!-- 步骤6: 解决方案 -->
    <div class="section" id="step6">
        <h3>步骤 6: 解决方案</h3>
        <button onclick="showSolutions()">显示解决方案</button>
        <div id="solutions"></div>
    </div>

    <script>
        let diagnosticData = {
            basicCheck: false,
            networkCheck: false,
            permissionCheck: false,
            deviceCheck: false,
            testResults: []
        };

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function checkBasicEnvironment() {
            logResult('basicResults', '<span class="loading"></span> 正在检查基础环境...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                // 检查 Geolocation API 支持
                if (navigator.geolocation) {
                    results.push('✅ 浏览器支持 Geolocation API');
                } else {
                    results.push('❌ 浏览器不支持 Geolocation API');
                }
                
                // 检查 HTTPS
                if (location.protocol === 'https:') {
                    results.push('✅ 使用 HTTPS 协议');
                } else {
                    results.push('⚠️ 使用 HTTP 协议（生产环境需要 HTTPS）');
                }
                
                // 检查用户代理
                const userAgent = navigator.userAgent;
                results.push(`📱 浏览器: ${userAgent}`);
                
                // 检查平台
                results.push(`💻 平台: ${navigator.platform}`);
                
                // 检查在线状态
                if (navigator.onLine) {
                    results.push('✅ 设备在线');
                } else {
                    results.push('❌ 设备离线');
                }
                
                diagnosticData.basicCheck = true;
                logResult('basicResults', results.join('<br>'), 'success');
            }, 1000);
        }

        function checkNetwork() {
            logResult('networkResults', '<span class="loading"></span> 正在检查网络连接...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                // 检查在线状态
                if (navigator.onLine) {
                    results.push('✅ 网络连接正常');
                } else {
                    results.push('❌ 网络连接异常');
                }
                
                // 测试网络延迟
                const startTime = performance.now();
                fetch('/favicon.ico', { method: 'HEAD' })
                    .then(() => {
                        const endTime = performance.now();
                        const latency = endTime - startTime;
                        results.push(`📊 网络延迟: ${latency.toFixed(2)}ms`);
                        
                        if (latency < 100) {
                            results.push('✅ 网络延迟正常');
                        } else if (latency < 500) {
                            results.push('⚠️ 网络延迟较高');
                        } else {
                            results.push('❌ 网络延迟过高');
                        }
                        
                        diagnosticData.networkCheck = true;
                        logResult('networkResults', results.join('<br>'), 'success');
                    })
                    .catch(() => {
                        results.push('❌ 网络请求失败');
                        diagnosticData.networkCheck = true;
                        logResult('networkResults', results.join('<br>'), 'error');
                    });
            }, 1000);
        }

        function checkPermissions() {
            logResult('permissionResults', '<span class="loading"></span> 正在检查位置权限...', 'info');
            
            setTimeout(() => {
                let results = [];
                
                if (navigator.permissions && navigator.permissions.query) {
                    navigator.permissions.query({ name: 'geolocation' }).then(result => {
                        results.push(`🔐 权限状态: ${result.state}`);
                        
                        switch (result.state) {
                            case 'granted':
                                results.push('✅ 位置权限已授予');
                                break;
                            case 'denied':
                                results.push('❌ 位置权限被拒绝');
                                break;
                            case 'prompt':
                                results.push('⚠️ 需要用户确认位置权限');
                                break;
                        }
                        
                        diagnosticData.permissionCheck = true;
                        logResult('permissionResults', results.join('<br>'), 
                            result.state === 'granted' ? 'success' : 'warning');
                    });
                } else {
                    results.push('⚠️ 无法查询权限状态（浏览器不支持）');
                    results.push('💡 请手动检查浏览器设置');
                    diagnosticData.permissionCheck = true;
                    logResult('permissionResults', results.join('<br>'), 'warning');
                }
            }, 1000);
        }

        function testLowAccuracy() {
            testGeolocation('低精度模式', {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 0
            });
        }

        function testHighAccuracy() {
            testGeolocation('高精度模式', {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }

        function testWithCache() {
            testGeolocation('缓存模式', {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000
            });
        }

        function testGeolocation(mode, options) {
            const startTime = performance.now();
            logResult('testResults', `<span class="loading"></span> 正在测试${mode}...`, 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    const result = {
                        mode: mode,
                        success: true,
                        duration: duration,
                        accuracy: position.coords.accuracy,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    diagnosticData.testResults.push(result);
                    
                    logResult('testResults', `
                        ✅ ${mode}测试成功<br>
                        ⏱️ 耗时: ${duration.toFixed(2)}ms<br>
                        📍 精度: ${position.coords.accuracy}米<br>
                        🌍 坐标: ${position.coords.latitude}, ${position.coords.longitude}
                    `, 'success');
                },
                function(error) {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    const result = {
                        mode: mode,
                        success: false,
                        duration: duration,
                        error: error.code,
                        message: error.message
                    };
                    
                    diagnosticData.testResults.push(result);
                    
                    let errorMessage = '';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '权限被拒绝';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置不可用';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '请求超时';
                            break;
                        default:
                            errorMessage = '未知错误';
                    }
                    
                    logResult('testResults', `
                        ❌ ${mode}测试失败<br>
                        ⏱️ 耗时: ${duration.toFixed(2)}ms<br>
                        🚨 错误: ${errorMessage}<br>
                        📝 详情: ${error.message}
                    `, 'error');
                },
                options
            );
        }

        function showSolutions() {
            let solutions = [];
            
            // 基于诊断结果提供解决方案
            if (!diagnosticData.basicCheck) {
                solutions.push('🔧 请先完成基础环境检查');
            }
            
            if (!diagnosticData.networkCheck) {
                solutions.push('🔧 请先完成网络检查');
            }
            
            if (!diagnosticData.permissionCheck) {
                solutions.push('🔧 请先完成权限检查');
            }
            
            // 通用解决方案
            solutions.push(`
                <h4>🛠️ 常见解决方案：</h4>
                <ol>
                    <li><strong>检查位置权限</strong>：点击浏览器地址栏左侧的锁定图标，确保位置权限为"允许"</li>
                    <li><strong>开启设备位置服务</strong>：在设备设置中开启位置服务</li>
                    <li><strong>检查GPS</strong>：确保GPS已开启（移动设备）</li>
                    <li><strong>网络连接</strong>：确保网络连接正常</li>
                    <li><strong>防火墙设置</strong>：检查防火墙是否阻止了位置服务</li>
                    <li><strong>浏览器设置</strong>：清除浏览器缓存和Cookie</li>
                    <li><strong>尝试不同模式</strong>：使用低精度模式可能更快</li>
                    <li><strong>更换位置</strong>：在室外或靠近窗户的地方尝试</li>
                </ol>
            `);
            
            // 基于测试结果的建议
            if (diagnosticData.testResults.length > 0) {
                const successfulTests = diagnosticData.testResults.filter(r => r.success);
                const failedTests = diagnosticData.testResults.filter(r => !r.success);
                
                if (successfulTests.length > 0) {
                    solutions.push(`
                        <h4>✅ 成功的测试：</h4>
                        <ul>
                            ${successfulTests.map(t => `<li>${t.mode}：${t.duration.toFixed(2)}ms，精度${t.accuracy}米</li>`).join('')}
                        </ul>
                    `);
                }
                
                if (failedTests.length > 0) {
                    solutions.push(`
                        <h4>❌ 失败的测试：</h4>
                        <ul>
                            ${failedTests.map(t => `<li>${t.mode}：${t.message}</li>`).join('')}
                        </ul>
                    `);
                }
            }
            
            logResult('solutions', solutions.join('<br>'), 'info');
        }

        // 页面加载时自动开始基础检查
        window.onload = function() {
            setTimeout(checkBasicEnvironment, 500);
        };
    </script>
</body>
</html> 